<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>    
    <title>东篱</title>
    <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
    <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
    <link rel='stylesheet' href='/styles/screen.css' type='text/css' />
    <link rel='stylesheet' href='/styles/prettify.css' type='text/css' />
  </head>
  <body>
    <div id="page">      
      <div id="header">
        <ul>
          <li><a href="/">首页</a></li>
          <li><a href="/blog">归档</a></li>
          <li><a href="/blog/feed">订阅</a></li>
          <li><a href="https://github.com/likang">GITHUB</a></li>
        </ul>
        <h1><a href="/">东篱</a></h1>
      </div>
      <div id="pagestripe">
        <div id="pageblock"></div>
      </div>

      <div id="content" class="single">        
  
<div class="post">
  <h2>
    <a href="/blog/2012/04/14/puff-girl" rel="bookmark" title="Permanent Link to 泡芙女孩">泡芙女孩</a> 
  </h2>
  <h4 style="margin-top: 0px;">
    2012/04/14 · 


<a href='/blog/category/life'>Life</a> · <a href='/blog/category/fairy-tale'>Fairy Tale</a>

  </h4>

    
  <p>我听说从前有个男孩，很喜欢吃泡芙，有一次调皮，在睡前小心翼翼的只把泡芙里的奶油吃掉，留下一个壳子，第二天竟然发现泡芙里有一个小女孩，便问她叫什么名字，女孩说不能说出自己的名字，一旦说出就会变回原型，不能待在这里了。男孩问会变成什么，女孩答这也不能说。</p>
<p>就这样男孩有了玩伴，他让妈妈把每件上衣都缝一个口袋在前面，这样把女孩放在里面，可以一起吹风。男孩带着女孩跑遍了城市的每个角落，每到一个地方，他们总是开心的说笑，所有人都觉得男孩奇怪，因为他们只看到他一个人。</p>
<p>小男孩慢慢长大了，一天早上忽然发现女孩不见了，他非常着急，翻箱倒柜，中间差点把泡芙小屋打破，可最终还是没有找到，他很伤心，呆坐床边，捧着空空的泡芙小屋。</p>
<p>这时门铃响了，男孩开门发现一个跟他差不多年纪的女孩站在外面，微笑着看着他。这感觉似曾相识，然后他猛然明白过来，一把把女孩抱进来，知道他找到了他的泡芙女孩。</p>


    <div class="separator"></div>
</div>



  
<div class="post">
  <h2>
    <a href="/blog/2012/04/13/calculate-character-width-in-python" rel="bookmark" title="Permanent Link to Python中计算字符宽度">Python中计算字符宽度</a> 
  </h2>
  <h4 style="margin-top: 0px;">
    2012/04/13 · 


<a href='/blog/category/python'>Python</a>

  </h4>

    
  <p>最近在用python写一个CLI小程序，其中涉及到计算字符宽度，目标是以友好的方式将一个长字符串截取为等宽的片段。</p>
<p>对于unicode字符，python的len函数可以准确的计算其中所包含的字符个数，但是个数并不代表宽度，如：</p>
<pre><code>&gt;&gt;&gt;len(u'你好a')
3
</code></pre>
<p>因此无法简单的使用这种方式来计算宽度。</p>
<h3>GBK decode</h3>
<p>首先我想到<a href="http://zh.wikipedia.org/zh/GBK">GBK</a>编码，00–7F范围内的字符是一字节编码，其余是双字节编码，正好与字符的宽度大体一致，于是有了这样的投机取巧的办法（假设取8个宽度）：</p>
<pre><code>&gt;&gt;&gt; a = u'hello你好'
&gt;&gt;&gt; b=a.encode('gbk')
&gt;&gt;&gt; try:
...   print b[:8].decode('gbk')
... except:
...   print b[:7].decode('gbk')
... 
hello你
</code></pre>
<p>如代码所示，首先将unicode的字符串进行GBK编码，然后截取8个字节的宽度后尝试用GBK解码，若解码失败，则少截取一个宽度，截取7个字节后使用GBK解码。</p>
<p>虽然初步解决了问题，但是这样做的硬伤很明显。首先代码不优雅，以试错的方式运行；其次GBK所能表示的字符有限，对于大量GBK编码以外的字符无法支持。</p>
<h3>East_Asian_Width</h3>
<p>徘徊很久之后，偶然发现 <a href="http://www.unicode.org/reports/tr44/tr44-4.html">Unicode Character Database</a>标准中有East_Asian_Width 属性，并有以下可能值：</p>
<pre><code># East_Asian_Width (ea)

ea ; A         ; Ambiguous    不确定
ea ; F         ; Fullwidth    全宽
ea ; H         ; Halfwidth    半宽
ea ; N         ; Neutral      中性
ea ; Na        ; Narrow       窄
ea ; W         ; Wide         宽
</code></pre>
<p>其中除A不确定外，F/H/N/Na/W都能很明确的知道宽度，如果保守起见，将A视为宽度为2的话，则很容易给出单个字符的宽度：</p>
<pre><code>&gt;&gt;&gt; import unicodedata
&gt;&gt;&gt; def chr_width(c):
...   if (unicodedata.east_asian_width(c) in ('F','W','A')):
...     return 2
...   else:
...     return 1
&gt;&gt;&gt; chr_width(u'你')
2
&gt;&gt;&gt; chr_width(u'a')
1
</code></pre>
<p>到现在似乎已经可以满足要求了，但是实际使用中发现属性为A的字符真不少见，最典型的就是中文的双引号：</p>
<pre><code>&gt;&gt;&gt; chr_width(u'”')
2
</code></pre>
<p>在大多数等宽字体中，中文双引号都是只占一位宽的，如果一行里有多个中文双引号，则累加的误判宽度将会使截取效果大打折扣，无疑这也不是最好的办法。</p>
<h3>urwid的解决方案</h3>
<p><a href="http://excess.org/urwid/">urwid</a>是一个成熟的python终端UI库，它在curses的基础之上包装了类似HTML的控件用以显示文本内容，如果有这方面的开发需求，非常推荐此库，比直接使用curses库方便很多，非常棒的是它对unicode的文本宽度截取非常准确，让我大为惊讶，于是翻开它的源码一探究竟，文本宽度计算方面其核心代码如下：</p>
<pre><code>widths = [
    (126,    1), (159,    0), (687,     1), (710,   0), (711,   1), 
    (727,    0), (733,    1), (879,     0), (1154,  1), (1161,  0), 
    (4347,   1), (4447,   2), (7467,    1), (7521,  0), (8369,  1), 
    (8426,   0), (9000,   1), (9002,    2), (11021, 1), (12350, 2), 
    (12351,  1), (12438,  2), (12442,   0), (19893, 2), (19967, 1),
    (55203,  2), (63743,  1), (64106,   2), (65039, 1), (65059, 0),
    (65131,  2), (65279,  1), (65376,   2), (65500, 1), (65510, 2),
    (120831, 1), (262141, 2), (1114109, 1),
]

def get_width( o ):
    """Return the screen column width for unicode ordinal o."""
    global widths
    if o == 0xe or o == 0xf:
        return 0
    for num, wid in widths:
        if o &lt;= num:
            return wid
    return 1
</code></pre>
<p>如代码所示，首先根据unicode的官方<a href="http://www.unicode.org/Public/4.0-Update/EastAsianWidth-4.0.0.txt">EastAsianWidth文档</a>整理出字符宽度的范围表，然后使用unicode代码查表。使用之前的例子测试：</p>
<pre><code>&gt;&gt;&gt; get_width(ord(u'a'))
1
&gt;&gt;&gt; get_width(ord(u'你'))
2
&gt;&gt;&gt; get_width(ord(u'”'))
1
</code></pre>
<p>完全准确，而且在实际应用中的表现也比较好，是一个理想的解决方案，更多技巧请查阅urwid的<a href="https://github.com/wardi/urwid/blob/master/urwid/old_str_util.py">old_str_util.py</a>源码。</p>


    <div class="separator"></div>
</div>



  
<div class="post">
  <h2>
    <a href="/blog/2012/04/12/i-have-a-window" rel="bookmark" title="Permanent Link to 我有一个窗户">我有一个窗户</a> 
  </h2>
  <h4 style="margin-top: 0px;">
    2012/04/12 · 


<a href='/blog/category/life'>Life</a>

  </h4>

    
  <p>我有一个窗户，早晨醒来，可以享受温暖的太阳；</p>
<p>我有一个窗户，斜倚在窗口，可以看见夜晚的霓虹灯光；</p>
<p>我有一个窗户，在这四月天，可以闻到桃花的清香；</p>
<p>我有一个窗户，满载着世界，静静流淌。</p>


    <div class="separator"></div>
</div>



  
<div class="post">
  <h2>
    <a href="/blog/2012/04/12/two-leaves" rel="bookmark" title="Permanent Link to 两片树叶">两片树叶</a> 
  </h2>
  <h4 style="margin-top: 0px;">
    2012/04/12 · 


<a href='/blog/category/life'>Life</a>

  </h4>

    
  <p>有两片树叶，离的很近，但不在一枝上。</p>
<p>刚发芽的时候，都对这个世界充满了好奇，微风吹过，细雨滑过，阳光，均匀的撒过。</p>
<p>慢慢的，身子都舒展了开来，学会了随风摇曳，也注意到了旁边的那一片。却都默不做声。</p>
<p>一天，起了大风，树叶们左摇右晃，几乎要离开树干，忽然，两片被风吹到了一起，划过的那一刻，发出沙的一声……很奇妙，两个都笑了，笑的哗哗的。</p>
<p>秋天到了。</p>
<p>“我可能要先下去了”，一片说，“希望落的不远”。</p>
<p>大风又起。它纵身一跃，翻转在忽左忽右的风中……</p>
<p>树上的另一片借着风向转身，努力搜寻着地面，“看见你了……”，可惜地上的它听不到。</p>
<p>一个午后，“刚才你在空中真美”一片对另一片说。</p>


    <div class="separator"></div>
</div>



  
<div class="post">
  <h2>
    <a href="/blog/2012/02/12/lantern-festival-memories" rel="bookmark" title="Permanent Link to 元宵节忆旧">元宵节忆旧</a> 
  </h2>
  <h4 style="margin-top: 0px;">
    2012/02/12 · 


<a href='/blog/category/life'>Life</a>

  </h4>

    
  <p>今年元宵节的前一天，老妈打来电话，让我自己煮点汤圆吃，我说我正有此打算。</p>
<p>于是下班跑到超市买了汤圆，回家用电饭锅煮了吃，很久没吃，还挺好吃的。其实不在老家的年份里，我对元宵节一点也不敏感，并没有把它当作一个节日。</p>
<p>去年是在朋友家里蹭的元宵吃，小两口把晚饭弄的挺丰富，我也一点没客气，吃的汤圆最多。记得真正第一次吃元宵是在大一，我们班的助理辅导员，凯，邀请我去他们宿舍吃汤圆，大家都没有煮汤圆的经验，只有几个人依稀记得汤圆浮起来就算熟了……好在最后大家都分到了汤圆，围着客厅的小桌子大叫好吃。</p>
<p>这位学长有诸多传奇故事，据说文采非凡，高中便出过散文集，大学时还把一个远在巴黎的女孩子追到……当时我对这些八卦都不感兴趣，但他谈吐文雅，机智幽默给我留下了很深的印象，不知道以后还能不能再见到一面。后来有一次又去他的宿舍，好像是去借U盘，他顺便在U盘里拷贝了些他推荐的东西，有很多，我只记得其中有一个.mht文件，名为《邪童正史》，我印象深刻，只可惜初入大学时对读书不感兴趣，现在都没有完整看过，也许我应该哪天翻出来看一看。</p>
<p>前面说到真正第一次吃汤圆是在大一，那之前元宵节我都干嘛去了……其实我们老家正月十五没有吃汤圆的习惯，我很少看到有卖汤圆的，我们自己也不做汤圆，而是做面灯。</p>
<p>面灯就是用面蒸出一个中空的小容器，类似仰着放的窝窝头，但是比窝窝头中间留的空间大，而且底是平的，不是圆的。蒸出后中间用一根裹着棉花的火柴插在中间作为灯芯，然后面灯里放入豆油或者猪油，这样就可以像蜡烛一样点燃啦，而且比蜡烛燃烧的时间长。普通的面灯只是在周围捏上花边，有一种特别的面灯会在面灯上盘一个龙，在龙嘴里放入一枚硬币，然后把它点燃后放在存放粮食的房间，用以祈求丰收。如果谁家有人去世，邻居还会送点面灯过去以示礼节。</p>
<p>大人们做好面灯后，等到天黑，小朋友们就可以每人拿着一盏面灯出去溜达了，大人们也都会出来聊天，有家里稍微富裕、又有还不能到处溜达的小孩子的，就会拎个电子的花灯出来给自家小孩子玩，甚是让人羡慕。</p>
<p>拿到花灯后，有的小朋友会别出心裁，在面灯外做点装饰，比如我:D  那个时候没什么材料，基本是在大人们喝酒用下来的空纸盒子上做文章，比如捥成一个花形啊、周围戳出小孔组成图案啊之类的……小时候很喜欢做这些小手工，后来我不做的年头，看到有小朋友做的更好看。</p>
<p>等到面灯燃烬了，把灯芯拔掉就可以直接吃了。由于用火烤过，还有点现在烧烤里烤馒头的味道，又有油在上面，所以一般都吃的特香。吃完面灯，月光还正亮，小朋友们就开始疯玩了，成群结队的，玩打架，玩捉迷藏或者干脆就是疯跑，总会弄到很晚才回家。</p>
<p>只可惜现在过节的味儿越来越淡，汤圆是吃上了，童年的那些趣事再也不会出现。</p>


    <div class="separator"></div>
</div>




<div id="pagination">
  <p class="alignleft">
    <a href="/blog/page/2">« 旧文</a>
  </p>
</div>
<div class="clear"></div>

      </div><!-- End Main Block -->
      <div id="footer" class="single">        
        <p id="credits">Likang.me uses <a href="http://www.ulfpettersson.se/design/modern/">Modern</a> and powered by <a href="http://www.blogofile.com">Blogofile</a>. 
        <br/></p>
        <script type="text/javascript" src="/javascripts/prettify.js"></script>
        <script type="text/javascript">
            window.onload = function(){
                if (!document.getElementsByTagName) return;
                var codes = document.getElementsByTagName("code");
                for (var i=0; i < codes.length; i++) {
                    codes[i].className = "prettyprint";
                }
                prettyPrint();
            }
        </script>

      </div> <!-- End Footer -->
    </div> <!-- End Content -->
  </body>
</html>
